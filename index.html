<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sensor Data Live Viewer</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f7f9fb; font-family: "Inter", sans-serif; }
    h1 { margin-top: 1rem; font-weight: 600; }
    #controls { margin-top: 1rem; margin-bottom: 1rem; }
    .value-card {
      background: white; border-radius: 0.75rem; padding: 1rem; 
      box-shadow: 0 2px 6px rgba(0,0,0,0.1); text-align:center;
    }
    .stats-card {
      background: #fff; border-radius: 0.75rem; padding: 1rem; 
      box-shadow: 0 2px 6px rgba(0,0,0,0.05); font-size: 0.9rem;
    }
    .plot-container {
      background: white; border-radius: 0.75rem; padding: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 1rem;
    }
    .smalltext { font-size: 0.9rem; color: #555; }
  </style>
</head>
<body>
<div class="container">
  <h1>ðŸ“± Live Sensor Dashboard</h1>
  <p class="text-muted">Stream accelerometer & gyroscope data from your mobile sensors in real time.</p>

  <div id="controls" class="row g-3 align-items-center">
    <div class="col-auto">
      <label for="rateSelect" class="form-label mb-0">Sampling rate (Hz):</label>
      <input id="rateSelect" type="number" min="1" max="100" value="50" class="form-control">
    </div>
    <div class="col-auto">
      <label for="accSelect" class="form-label mb-0">Accelerometer type:</label>
      <select id="accSelect" class="form-select">
        <option value="linear" selected>Linear (no gravity)</option>
        <option value="gravity">Including gravity</option>
      </select>
    </div>
    <div class="col-auto">
      <label for="gyroUnit" class="form-label mb-0">Gyro units:</label>
      <select id="gyroUnit" class="form-select">
        <option value="deg">Degrees/s</option>
        <option value="rad" selected>Radians/s</option>
      </select>
    </div>
    <div class="col-auto">
      <button id="toggleButton" class="btn btn-success mt-3">Start</button>
    </div>
  </div>

  <div class="row text-center">
    <div class="col-md-6">
      <div class="value-card">
        <h5 id="accTitle">Accelerometer (m/sÂ²)</h5>
        <div>X: <span id="ax">0</span></div>
        <div>Y: <span id="ay">0</span></div>
        <div>Z: <span id="az">0</span></div>
      </div>
      <div class="stats-card mt-3 text-start">
        <strong>Accelerometer Stats</strong><br>
        Mean: X=<span id="accMeanX">0</span>, Y=<span id="accMeanY">0</span>, Z=<span id="accMeanZ">0</span><br>
        Min: X=<span id="accMinX">0</span>, Y=<span id="accMinY">0</span>, Z=<span id="accMinZ">0</span><br>
        Max: X=<span id="accMaxX">0</span>, Y=<span id="accMaxY">0</span>, Z=<span id="accMaxZ">0</span><br>
        Samples: <span id="accSamples">0</span> â€” Duration: <span id="accDuration">0</span> s
      </div>
    </div>

    <div class="col-md-6">
      <div class="value-card">
        <h5 id="gyroTitle">Gyroscope (rad/s)</h5>
        <div>X: <span id="gx">0</span></div>
        <div>Y: <span id="gy">0</span></div>
        <div>Z: <span id="gz">0</span></div>
      </div>
      <div class="stats-card mt-3 text-start">
        <strong>Gyroscope Stats</strong><br>
        Mean: X=<span id="gyroMeanX">0</span>, Y=<span id="gyroMeanY">0</span>, Z=<span id="gyroMeanZ">0</span><br>
        Min: X=<span id="gyroMinX">0</span>, Y=<span id="gyroMinY">0</span>, Z=<span id="gyroMinZ">0</span><br>
        Max: X=<span id="gyroMaxX">0</span>, Y=<span id="gyroMaxY">0</span>, Z=<span id="gyroMaxZ">0</span><br>
        Samples: <span id="gyroSamples">0</span> â€” Duration: <span id="gyroDuration">0</span> s
      </div>
    </div>
  </div>

  <div class="plot-container mt-4">
    <h5 id="accPlotTitle">Accelerometer (m/sÂ²)</h5>
    <div id="accPlot"></div>
  </div>
  <div class="plot-container">
    <h5 id="gyroPlotTitle">Gyroscope (rad/s)</h5>
    <div id="gyroPlot"></div>
  </div>
</div>

<script>
  let isRunning = false;
  const toggleBtn = document.getElementById("toggleButton");
  const rateInput = document.getElementById("rateSelect");
  const accSelect = document.getElementById("accSelect");
  const gyroUnitSelect = document.getElementById("gyroUnit");

  const accData = {x: [], y: [], z: [], t: [], ts: []};
  const gyroData = {x: [], y: [], z: [], t: [], ts: []};
  const maxDuration = 5;
  let lastUpdate = 0;
  let maxAccAbs = 1;
  let maxGyroAbs = 1;
  let startTime = null;

  const fmtTime = (t) => new Date(t * 1000).toLocaleTimeString([], {hour12:false});

  function setupPlots() {
    const accUnit = "m/sÂ²";
    const gyroUnit = gyroUnitSelect.value === "rad" ? "rad/s" : "Â°/s";

    Plotly.newPlot('accPlot', [
      {y:[], mode:'lines', name:'X', line:{color:'red'}},
      {y:[], mode:'lines', name:'Y', line:{color:'green'}},
      {y:[], mode:'lines', name:'Z', line:{color:'blue'}}
    ], {
      margin:{t:10}, 
      xaxis:{title:'Elapsed Time (s)'},
      xaxis2:{
        title:'Timestamp (HH:MM:SS)',
        overlaying:'x', side:'top',
        tickmode:'array', tickvals:[], ticktext:[]
      },
      yaxis:{title:`Acceleration (${accUnit})`, range:[-maxAccAbs, maxAccAbs]}
    });

    Plotly.newPlot('gyroPlot', [
      {y:[], mode:'lines', name:'X', line:{color:'orange'}},
      {y:[], mode:'lines', name:'Y', line:{color:'purple'}},
      {y:[], mode:'lines', name:'Z', line:{color:'teal'}}
    ], {
      margin:{t:10}, 
      xaxis:{title:'Elapsed Time (s)'},
      xaxis2:{
        title:'Timestamp (HH:MM:SS)',
        overlaying:'x', side:'top',
        tickmode:'array', tickvals:[], ticktext:[]
      },
      yaxis:{title:`Rotation (${gyroUnit})`, range:[-maxGyroAbs, maxGyroAbs]}
    });
  }

  setupPlots();

  function updateTitles() {
    const accUnit = "m/sÂ²";
    const gyroUnit = gyroUnitSelect.value === "rad" ? "rad/s" : "Â°/s";
    document.getElementById("accTitle").textContent = `Accelerometer (${accUnit})`;
    document.getElementById("gyroTitle").textContent = `Gyroscope (${gyroUnit})`;
    document.getElementById("accPlotTitle").textContent = `Accelerometer (${accUnit})`;
    document.getElementById("gyroPlotTitle").textContent = `Gyroscope (${gyroUnit})`;
    Plotly.relayout('accPlot', {'yaxis.title': `Acceleration (${accUnit})`});
    Plotly.relayout('gyroPlot', {'yaxis.title': `Rotation (${gyroUnit})`});
  }

  gyroUnitSelect.addEventListener('change', updateTitles);
  accSelect.addEventListener('change', updateTitles);

  function handleMotion(e){
    const now = performance.now() / 1000;
    const rate = Math.min(Math.max(parseFloat(rateInput.value) || 50, 1), 100);
    if(now - lastUpdate < 1 / rate) return;
    if(!startTime) startTime = now;
    lastUpdate = now;

    const useGravity = accSelect.value === "gravity";
    const accel = useGravity ? e.accelerationIncludingGravity : e.acceleration;
    const rotation = e.rotationRate;

    let ax = accel?.x ?? 0, ay = accel?.y ?? 0, az = accel?.z ?? 0;
    let gx = rotation?.beta ?? 0, gy = rotation?.gamma ?? 0, gz = rotation?.alpha ?? 0;

    if (gyroUnitSelect.value === "rad") {
      gx *= Math.PI / 180; gy *= Math.PI / 180; gz *= Math.PI / 180;
    }

    document.getElementById('ax').textContent = ax.toFixed(2);
    document.getElementById('ay').textContent = ay.toFixed(2);
    document.getElementById('az').textContent = az.toFixed(2);
    document.getElementById('gx').textContent = gx.toFixed(2);
    document.getElementById('gy').textContent = gy.toFixed(2);
    document.getElementById('gz').textContent = gz.toFixed(2);

    const realTs = Date.now() / 1000;
    accData.x.push(ax); accData.y.push(ay); accData.z.push(az); accData.t.push(now); accData.ts.push(realTs);
    gyroData.x.push(gx); gyroData.y.push(gy); gyroData.z.push(gz); gyroData.t.push(now); gyroData.ts.push(realTs);

    const cutoff = now - maxDuration;
    for (let d of [accData, gyroData]) {
      while (d.t.length && d.t[0] < cutoff) {
        d.t.shift(); d.x.shift(); d.y.shift(); d.z.shift(); d.ts.shift();
      }
    }

    const accTicks = accData.t.filter((_,i)=>i%10===0);
    const accLabels = accData.ts.filter((_,i)=>i%10===0).map(fmtTime);
    const gyroTicks = gyroData.t.filter((_,i)=>i%10===0);
    const gyroLabels = gyroData.ts.filter((_,i)=>i%10===0).map(fmtTime);

    Plotly.update('accPlot', {x:[accData.t, accData.t, accData.t], y:[accData.x, accData.y, accData.z]}, {}, [0,1,2]);
    Plotly.relayout('accPlot', {'xaxis2.tickvals': accTicks, 'xaxis2.ticktext': accLabels});
    Plotly.update('gyroPlot', {x:[gyroData.t, gyroData.t, gyroData.t], y:[gyroData.x, gyroData.y, gyroData.z]}, {}, [0,1,2]);
    Plotly.relayout('gyroPlot', {'xaxis2.tickvals': gyroTicks, 'xaxis2.ticktext': gyroLabels});

    updateStats();
  }

  function mean(arr) { return arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : 0; }

  function updateStats() {
    const update = (prefix, data, start) => {
      document.getElementById(`${prefix}MeanX`).textContent = mean(data.x).toFixed(2);
      document.getElementById(`${prefix}MeanY`).textContent = mean(data.y).toFixed(2);
      document.getElementById(`${prefix}MeanZ`).textContent = mean(data.z).toFixed(2);
      document.getElementById(`${prefix}MinX`).textContent = Math.min(...data.x).toFixed(2);
      document.getElementById(`${prefix}MinY`).textContent = Math.min(...data.y).toFixed(2);
      document.getElementById(`${prefix}MinZ`).textContent = Math.min(...data.z).toFixed(2);
      document.getElementById(`${prefix}MaxX`).textContent = Math.max(...data.x).toFixed(2);
      document.getElementById(`${prefix}MaxY`).textContent = Math.max(...data.y).toFixed(2);
      document.getElementById(`${prefix}MaxZ`).textContent = Math.max(...data.z).toFixed(2);
      document.getElementById(`${prefix}Samples`).textContent = data.x.length;
      document.getElementById(`${prefix}Duration`).textContent = (performance.now()/1000 - start).toFixed(1);
    };
    if(startTime) {
      update("acc", accData, startTime);
      update("gyro", gyroData, startTime);
    }
  }

  setInterval(() => {
    const newAccMax = Math.max(maxAccAbs, ...accData.x.map(Math.abs), ...accData.y.map(Math.abs), ...accData.z.map(Math.abs));
    const newGyroMax = Math.max(maxGyroAbs, ...gyroData.x.map(Math.abs), ...gyroData.y.map(Math.abs), ...gyroData.z.map(Math.abs));
    if (newAccMax > maxAccAbs) {
      maxAccAbs = newAccMax;
      Plotly.relayout('accPlot', {'yaxis.range': [-maxAccAbs, maxAccAbs]});
    }
    if (newGyroMax > maxGyroAbs) {
      maxGyroAbs = newGyroMax;
      Plotly.relayout('gyroPlot', {'yaxis.range': [-maxGyroAbs, maxGyroAbs]});
    }
  }, 5000);

  toggleBtn.onclick = async () => {
    if(isRunning){
      window.removeEventListener('devicemotion', handleMotion);
      toggleBtn.textContent = 'Start';
      toggleBtn.classList.replace('btn-danger','btn-success');
      isRunning = false;
    } else {
      if(DeviceMotionEvent && typeof DeviceMotionEvent.requestPermission === 'function'){
        try{ await DeviceMotionEvent.requestPermission(); }catch(e){ alert('Permission denied'); return; }
      }
      startTime = null;
      window.addEventListener('devicemotion', handleMotion);
      toggleBtn.textContent = 'Stop';
      toggleBtn.classList.replace('btn-success','btn-danger');
      isRunning = true;
    }
  };
</script>
</body>
</html>

